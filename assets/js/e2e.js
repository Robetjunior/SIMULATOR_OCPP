(function(){
  function log(t){var o=document.getElementById('logOutput');if(o){var s=new Date().toLocaleTimeString();o.textContent+="["+s+"] TEST "+t+"\n";o.scrollTop=o.scrollHeight;}}
  async function httpJson(method,url,headers,body){var res=await fetch(url,{method:method,headers:headers,body:body?JSON.stringify(body):undefined});var txt=await res.text();var json;try{json=JSON.parse(txt);}catch(e){json={raw:txt,status:res.status};}if(!res.ok)throw new Error('HTTP '+res.status+' '+txt.slice(0,200));return json;}
  async function runE2EFlow(opts){var base=opts.base||'http://35.231.137.231:3000';var id=opts.chargeBoxId||'DRBAKANA-TEST-03';var apiKey=opts.apiKey;var idTag=opts.idTag||'IGEA-USER-001';var connectorId=opts.connectorId||1;var headers={'X-API-Key':apiKey,'Accept':'application/json','Content-Type':'application/json'};log('[E2E] online list');var online=await httpJson('GET',base+'/v1/ocpp/online',headers);log('[E2E] snapshot');var snapBefore=await httpJson('GET',base+'/v1/ocpp/'+id+'/snapshot',headers);log('[E2E] remoteStart');await httpJson('POST',base+'/v1/commands/remoteStart?force=1',headers,{chargeBoxId:id,idTag:idTag,connectorId:connectorId});var deadline=Date.now()+90000;var detail=null;var txId=null;log('[E2E] poll session');while(Date.now()<deadline&&!txId){try{detail=await httpJson('GET',base+'/v1/sessions/active/'+id+'/detail',headers);txId=detail&&detail.session&&detail.session.transaction_id?detail.session.transaction_id:null;}catch(e){}if(!txId)await new Promise(function(r){setTimeout(r,2000);});}log('[E2E] txId='+(txId||'none'));if(!txId){var lastTx=await httpJson('GET',base+'/v1/debug/ocpp/last-tx/'+id,headers);if(lastTx&&lastTx.transaction_id)txId=lastTx.transaction_id;}if(txId){var authEv=await httpJson('GET',base+'/v1/events?event_type=Authorize&charge_box_id='+id+'&limit=3&sort=desc',headers);var startEv=await httpJson('GET',base+'/v1/events?event_type=StartTransaction&transaction_pk='+txId+'&limit=3&sort=desc',headers);log('[E2E] metervalues');var mv=await httpJson('GET',base+'/v1/events?event_type=MeterValues&transaction_pk='+txId+'&context=Sample.Periodic&limit=50&sort=desc',headers);var tele=await httpJson('GET',base+'/v1/sessions/active/'+id+'/detail',headers);log('[E2E] remoteStop');await httpJson('POST',base+'/v1/commands/remoteStop',headers,{transactionId:txId,chargeBoxId:id});await new Promise(function(r){setTimeout(r,5000);});var stopEv=await httpJson('GET',base+'/v1/events?event_type=StopTransaction&transaction_pk='+txId+'&limit=3&sort=desc',headers);var snapAfter=await httpJson('GET',base+'/v1/ocpp/'+id+'/snapshot',headers);return{online:online,snapBefore:snapBefore,txId:txId,authEv:authEv,startEv:startEv,mv:mv,tele:tele,stopEv:stopEv,snapAfter:snapAfter};}else{return{online:online,snapBefore:snapBefore,txId:null};}}
  window.runE2EFlow=runE2EFlow;
})();